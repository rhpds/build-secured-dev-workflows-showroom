= Module 2: Sign and Verify All Artifacts With *RHTAS* 

In Module 1, you established trust in what is inside your software. The next challenge customers face is: “How do we know these artifacts were really built by us and haven’t been tampered with?” They need assurance that both code commits and build artifacts originate from trusted sources—not rogue machines or compromised pipelines.

In this module, you will deploy Red Hat Trusted Artifact Signer (RHTAS) to establish the Root of Trust for the entire build system. Unlike "traditional" signing which uses long-lived static keys (which are a nightmare to rotate and secure), RHTAS uses Keyless Signing.
How Keyless Signing Works here:
1. Identity (Keycloak): We authenticate an entity (user or machine) via OIDC.
2. Certificate Authority (Fulcio): RHTAS issues a short-lived X.509 certificate bound to that OIDC identity.
3. Transparency Log (Rekor): The signature and the certificate are logged in an immutable ledger.
4. Verification: We trust the artifact not because we have a public key, but because we can cryptographically prove the certificate was valid at the time of signing and belongs to a trusted OIDC identity.


== 1: Configure the Machine Identity

Tekton Chains requires its own realm and client to sign images on behalf of the pipeline.
This isolates automated signing from human user identities and is considered best practice in customer deployments.

=== Step 1: Create tas-chains realm and tas client

* If you skipped module 1, click the *RHBK Console* tab in the Showroom and log in to the RHBK console using the following details:
* *Username*: {keycloak_admin_user}
* *Password*: {keycloak_admin_password}
* After entering your credentials,click the *Sign In* button.

* In the *RHBK Console* click on the "Manage Realm" link in the left navigation menu, then click on the *Create realm* button.

image::create_tas_realm.png[Create Realm,align="center"]

* In the create realm pop up, enter the name *tas-chains* and click the *Create* button.

image::create_tas_chains_realm.png[Create TAS Chains realm,align="center"]

* Next you you will create a new client, click on the "Clients" link in the left navigation menu, then click on the *Create client* button.

image::create_client.png[Create Client,align="center"]

* In the Create Client view, under General setting, set the Client ID to trusted-artifact-signer, then click Next.

image::tas_client_general_settings.png[New Client General Settings,align="center"]

* Under Capability Config set the following:
. Client authentication: toggle to on
. Standard flow: Make sure is ticked
. Service accounts roles: Tick
* Then click Next

image::tas_client_capability_config.png[New Client Capability Config,align="center"]

* Under Login Settings leave the default values and click Save.

image::tas_client_login_settings.png[New Client Login Settings,align="center"]

* Now scroll down and make sure Front channel logout is toggled on before you hit Save.

image::tas_client_logout_settings.png[New Client Logout Settings,align="center"]

* Next Switch to the service account roles tab and click the service-account-trusted-artifact-signer link

image::tas_client_service_account_roles.png[New Client Service Account Roles,align="center"]

* Set the following:
. VerifyEmail: Toggle to on
. Email: trusted-artifact-signer@demo.redhat.com
. First name: Trusted
. Last name: Content
* The click on *Save*

image::tas_client_service_account_details.png[New Client Service Account Roles,align="center"]

WARNING: This is the most common failure point in RHTAS deployments. Fulcio requires the OIDC token to contain a verified email claim. If this is missing, certificate issuance fails.

=== Step 2: Configure Developer Identity for Commit Signing

* Developers need a trusted identity to sign *Git* commits using *RHTAS*.
* This identity is separate from Tekton’s machine identity you configured in the last step and is configured in the existing sso realm.
* The client you create here enables OAuth-based authentication for developers performing commit signing.

* In the *RHBK Console*, click *Manage Realm* in the left navigation menu.
* Select the *sso* realm.

image::tas_sso_realm.png[TAS SSO Realm,align="center"]

* Navigate to *Clients* in the left menu and click *Create client*.

image::tas_create_client.png[TAS Create Client,align="center"]

* In the *General setting* page:
. Set the *Client ID* to *trusted-artifact-signer*.
. Click *Next*.

image::tas_client_general_settings.png[New Client General Settings,align="center"]

* Under Capability Config set:
. *Standard flow*: Make sure this checkbox is ticked.
. *Direct Access Grants*: Tick this checkbox.
* Then click *Next*.

image::tas_commit_client_capability_config.png[New Client Capability Config,align="center"]

* In the *Login Settings* page, add the following *Valid Direct URIs*:
. Add the first URI: *urn:ietf:wg:oauth:2.0:oob*
. Click *Add valid redirect URIs*, then input: ***
* Click *Save*
* This allows tools like *RHTAS* to complete the OAuth authentication flow.

image::tas_commit_client_client_login_settings.png[New Client Login Settings,align="center"]

* Now scroll down to the *Logout settings* section and set the *Front channel logout* toggle to *Off*. 
* Then click *Save*

image::tas_commit_client_logout_settings.png[New Client Logout Settings,align="center"]


=== Step 3: Deploy the RHTAS Instance

Now you can deploy the RHTAS components—Fulcio, Rekor, Trillian and TUF—using the Operator-backed Custom Resource by running the following commands:

* Set the required variables

[source, role="execute", subs="attributes"]
----
cat << 'EOF' >> ~/.bashrc
export TAS_CHAINS_REALM={tas_chains_realm}
export TAS_SSO_REALM={tas_sso_realm}
EOF
source ~/.bashrc
----

* Run the following command to apply the *RHTAS* Instance CR:

[source, role="execute"]
----
envsubst < ~/lab-assets/tas-instance.yml | oc apply -n tssc-tas -f -
----